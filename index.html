<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Payment Tracker — Attendance & Earnings</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link href="https://fonts.googleapis.com/css2?family=Bebas+Neue&family=Outfit:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/html5-qrcode@2.3.8/html5-qrcode.min.js"></script>
    <style>
        :root {
            --navy: #0056a8;
            --navy-mid: #003d7a;
            --navy-light: #0068cc;
            --navy-deep: #002952;
            --gold: #ffc107;
            --gold-light: #ffdd57;
            --gold-pale: #fff8e1;
            --gold-dark: #e6a800;
            --green: #28a745;
            --green-dark: #1e7e34;
            --green-bg: #e8f5e9;
            --red: #dc3545;
            --red-dark: #c62828;
            --red-bg: #fef2f2;
            --orange: #f59e0b;
            --orange-bg: #fffbeb;
            --teal: #0d9488;
            --teal-dark: #0f766e;
            --teal-bg: #f0fdfa;
            --purple: #7c3aed;
            --purple-bg: #f5f3ff;
            --bg: #f0f4f8;
            --card: #ffffff;
            --text: #0f172a;
            --text-mid: #475569;
            --text-light: #94a3b8;
            --border: #dfe3e8;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: 'Outfit', sans-serif;
            background: var(--bg);
            color: var(--text);
            min-height: 100vh;
            overflow-x: hidden;
        }

        /* ===== HEADER ===== */
        .top-bar {
            background: var(--navy);
            padding: 14px 20px;
            position: sticky;
            top: 0;
            z-index: 200;
            box-shadow: 0 4px 20px rgba(0,0,0,0.25);
        }

        .top-bar-inner {
            max-width: 540px;
            margin: 0 auto;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .brand { display: flex; align-items: center; gap: 12px; }

        .brand-badge {
            width: 40px; height: 40px;
            background: linear-gradient(135deg, var(--gold), var(--gold-dark));
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 4px 12px rgba(212,160,23,0.3);
        }

        .brand-badge svg { width: 22px; height: 22px; stroke: var(--navy); fill: none; stroke-width: 2.5; }

        .brand-text h1 {
            font-family: 'Bebas Neue', sans-serif;
            font-size: 22px;
            color: var(--gold);
            letter-spacing: 3px;
            line-height: 1;
        }

        .brand-text p { font-size: 9px; color: rgba(255,255,255,0.5); letter-spacing: 2px; font-weight: 600; text-transform: uppercase; }

        .status-dot {
            width: 8px; height: 8px;
            background: var(--green);
            border-radius: 50%;
            box-shadow: 0 0 8px rgba(16,185,129,0.6);
            animation: pulse-dot 2s infinite;
        }

        @keyframes pulse-dot {
            0%, 100% { box-shadow: 0 0 8px rgba(16,185,129,0.6); }
            50% { box-shadow: 0 0 16px rgba(16,185,129,0.9); }
        }

        /* ===== TABS ===== */
        .tabs-container {
            max-width: 540px;
            margin: 0 auto;
            padding: 20px 16px 0;
        }

        .tab-bar {
            display: flex;
            background: var(--navy);
            border-radius: 14px;
            padding: 4px;
            box-shadow: 0 4px 16px rgba(0,0,0,0.1);
        }

        .tab-btn {
            flex: 1;
            padding: 14px 6px;
            border: none;
            background: transparent;
            font-family: 'Bebas Neue', sans-serif;
            font-size: 15px;
            letter-spacing: 2px;
            color: rgba(255,255,255,0.4);
            cursor: pointer;
            border-radius: 11px;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
        }

        .tab-btn svg { width: 18px; height: 18px; stroke: currentColor; fill: none; stroke-width: 2; }

        .tab-btn.active { color: var(--navy); }

        .tab-btn.signin.active { background: linear-gradient(135deg, var(--gold), var(--gold-light)); }
        .tab-btn.signout.active { background: linear-gradient(135deg, var(--green), #34d399); color: #fff; }
        .tab-btn.stats.active { background: linear-gradient(135deg, var(--teal), #2dd4bf); color: #fff; }

        /* ===== MAIN CONTENT ===== */
        .main {
            max-width: 540px;
            margin: 0 auto;
            padding: 16px 16px 40px;
        }

        .tab-panel { display: none; }
        .tab-panel.active { display: block; animation: fadeUp 0.3s ease; }

        @keyframes fadeUp {
            from { opacity: 0; transform: translateY(12px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* ===== SCANNER ===== */
        .scanner-card {
            background: var(--card);
            border-radius: 16px;
            box-shadow: 0 4px 24px rgba(0,0,0,0.06);
            overflow: hidden;
            margin-bottom: 16px;
        }

        .scanner-header {
            padding: 16px 20px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .scanner-header.gold { background: linear-gradient(135deg, var(--gold-pale), #fef3c7); border-bottom: 2px solid var(--gold); }
        .scanner-header.green-hd { background: var(--green-bg); border-bottom: 2px solid var(--green); }

        .scanner-header svg { width: 22px; height: 22px; flex-shrink: 0; }
        .scanner-header.gold svg { stroke: var(--gold-dark); }
        .scanner-header.green-hd svg { stroke: var(--green-dark); }

        .scanner-title {
            font-family: 'Bebas Neue', sans-serif;
            font-size: 16px;
            letter-spacing: 2px;
        }

        .scanner-header.gold .scanner-title { color: var(--gold-dark); }
        .scanner-header.green-hd .scanner-title { color: var(--green-dark); }

        .scanner-body { padding: 20px; }

        .scan-area {
            width: 100%;
            max-width: 320px;
            margin: 0 auto;
            border-radius: 14px;
            overflow: hidden;
            position: relative;
            background: #000;
            aspect-ratio: 1;
        }

        .scan-area video { border-radius: 14px; }

        #reader-signin, #reader-signout { width: 100%; }
        #reader-signin video, #reader-signout video { border-radius: 14px !important; }

        .scan-overlay {
            text-align: center;
            padding: 40px 20px;
        }

        .scan-overlay svg { width: 64px; height: 64px; margin-bottom: 12px; }
        .scan-overlay p { font-size: 14px; color: var(--text-mid); font-weight: 500; }

        .scan-btn {
            margin-top: 16px;
            padding: 14px 32px;
            border: none;
            border-radius: 12px;
            font-family: 'Bebas Neue', sans-serif;
            font-size: 18px;
            letter-spacing: 2px;
            cursor: pointer;
            transition: all 0.2s;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }

        .scan-btn svg { width: 20px; height: 20px; stroke: currentColor; fill: none; }

        .scan-btn.gold-btn {
            background: linear-gradient(135deg, var(--gold), var(--gold-dark));
            color: var(--navy);
            box-shadow: 0 4px 16px rgba(212,160,23,0.3);
        }

        .scan-btn.green-btn {
            background: linear-gradient(135deg, var(--green), var(--green-dark));
            color: #fff;
            box-shadow: 0 4px 16px rgba(16,185,129,0.3);
        }

        .scan-btn:hover { transform: translateY(-2px); }

        .scan-btn.stop-btn {
            background: var(--red);
            color: #fff;
            box-shadow: 0 4px 16px rgba(239,68,68,0.3);
        }

        /* ===== USER INFO CARD ===== */
        .device-card {
            background: var(--card);
            border-radius: 16px;
            box-shadow: 0 4px 24px rgba(0,0,0,0.06);
            overflow: hidden;
            margin-bottom: 16px;
            display: none;
        }

        .device-card.show { display: block; animation: fadeUp 0.35s ease; }

        .device-card-top {
            padding: 20px;
            text-align: center;
            position: relative;
        }

        .device-card-top.gold-top { background: linear-gradient(135deg, var(--navy), var(--navy-mid)); }
        .device-card-top.green-top { background: linear-gradient(135deg, #065f46, var(--green-dark)); }
        .device-card-top.red-top { background: linear-gradient(135deg, #991b1b, var(--red-dark)); }
        .device-card-top.orange-top { background: linear-gradient(135deg, #92400e, #b45309); }

        .device-card-top::after {
            content: '';
            position: absolute;
            bottom: -1px; left: 0; right: 0;
            height: 16px;
            background: var(--card);
            border-radius: 16px 16px 0 0;
        }

        .device-status-badge {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 6px 16px;
            border-radius: 20px;
            font-family: 'Bebas Neue', sans-serif;
            font-size: 14px;
            letter-spacing: 2px;
            margin-bottom: 10px;
        }

        .badge-register { background: rgba(212,160,23,0.2); color: var(--gold-light); }
        .badge-returned { background: rgba(16,185,129,0.2); color: #6ee7b7; }
        .badge-error { background: rgba(239,68,68,0.2); color: #fca5a5; }
        .badge-warning { background: rgba(245,158,11,0.2); color: #fcd34d; }

        .device-status-badge svg { width: 16px; height: 16px; stroke: currentColor; fill: none; }

        .device-person {
            font-family: 'Bebas Neue', sans-serif;
            font-size: 26px;
            color: #fff;
            letter-spacing: 2px;
            line-height: 1.1;
        }

        .device-phone {
            font-size: 14px;
            color: rgba(255,255,255,0.6);
            margin-top: 4px;
            font-weight: 500;
        }

        .device-code-display {
            margin-top: 10px;
            font-family: 'Bebas Neue', sans-serif;
            font-size: 36px;
            letter-spacing: 5px;
        }

        .gold-top .device-code-display { color: var(--gold); }
        .green-top .device-code-display { color: #6ee7b7; }
        .red-top .device-code-display { color: #fca5a5; }
        .orange-top .device-code-display { color: #fcd34d; }

        .device-body { padding: 6px 20px 20px; }

        .info-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 8px;
            margin-bottom: 16px;
        }

        .info-cell {
            background: #f8fafc;
            border: 1px solid var(--border);
            border-radius: 10px;
            padding: 10px 12px;
        }

        .info-cell.full { grid-column: span 2; }

        .info-key {
            font-size: 9px;
            font-weight: 700;
            letter-spacing: 1.2px;
            color: var(--text-light);
            text-transform: uppercase;
            margin-bottom: 2px;
        }

        .info-val {
            font-size: 13px;
            font-weight: 600;
            color: var(--text);
            line-height: 1.3;
        }

        /* ===== ACTION BUTTONS ===== */
        .action-btn {
            width: 100%;
            padding: 16px;
            border: none;
            border-radius: 12px;
            font-family: 'Bebas Neue', sans-serif;
            font-size: 20px;
            letter-spacing: 3px;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }

        .action-btn svg { width: 22px; height: 22px; stroke: currentColor; fill: none; }

        .action-btn.register-action {
            background: linear-gradient(135deg, var(--gold), var(--gold-dark));
            color: var(--navy);
            box-shadow: 0 6px 24px rgba(212,160,23,0.3);
        }

        .action-btn.return-action {
            background: linear-gradient(135deg, var(--green), var(--green-dark));
            color: #fff;
            box-shadow: 0 6px 24px rgba(16,185,129,0.3);
        }

        .action-btn:hover { transform: translateY(-2px); }
        .action-btn:active { transform: translateY(0); }
        .action-btn:disabled { opacity: 0.5; cursor: not-allowed; transform: none !important; }

        .action-btn .spinner-sm {
            width: 20px; height: 20px;
            border: 3px solid rgba(255,255,255,0.3);
            border-top-color: currentColor;
            border-radius: 50%;
            animation: spin 0.7s linear infinite;
        }

        @keyframes spin { to { transform: rotate(360deg); } }

        /* ===== MESSAGE CARD ===== */
        .msg-card {
            background: var(--card);
            border-radius: 16px;
            box-shadow: 0 4px 24px rgba(0,0,0,0.06);
            overflow: hidden;
            margin-bottom: 16px;
            display: none;
            text-align: center;
            padding: 30px 20px;
        }

        .msg-card.show { display: block; animation: fadeUp 0.35s ease; }

        .msg-card svg { width: 56px; height: 56px; margin-bottom: 14px; }
        .msg-card.success-msg svg { stroke: var(--green); }
        .msg-card.error-msg svg { stroke: var(--red); }
        .msg-card.warning-msg svg { stroke: var(--orange); }

        .msg-title {
            font-family: 'Bebas Neue', sans-serif;
            font-size: 22px;
            letter-spacing: 2px;
            margin-bottom: 6px;
        }

        .success-msg .msg-title { color: var(--green-dark); }
        .error-msg .msg-title { color: var(--red-dark); }
        .warning-msg .msg-title { color: #b45309; }

        .msg-text {
            font-size: 14px;
            color: var(--text-mid);
            font-weight: 500;
            line-height: 1.5;
        }

        .msg-detail {
            margin-top: 10px;
            font-size: 12px;
            color: var(--text-light);
        }

        .scan-again-btn {
            margin-top: 20px;
            padding: 12px 28px;
            background: var(--navy);
            color: #fff;
            border: none;
            border-radius: 10px;
            font-family: 'Bebas Neue', sans-serif;
            font-size: 15px;
            letter-spacing: 2px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .scan-again-btn:hover { background: var(--navy-mid); }

        /* ===== HISTORY ===== */
        .history-card {
            background: var(--card);
            border-radius: 16px;
            box-shadow: 0 4px 24px rgba(0,0,0,0.06);
            overflow: hidden;
        }

        .history-header {
            padding: 14px 20px;
            background: #f8fafc;
            border-bottom: 1px solid var(--border);
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .history-title {
            font-family: 'Bebas Neue', sans-serif;
            font-size: 14px;
            letter-spacing: 2px;
            color: var(--text-mid);
        }

        .history-count {
            font-size: 11px;
            background: var(--navy);
            color: var(--gold);
            padding: 3px 10px;
            border-radius: 10px;
            font-weight: 700;
        }

        .history-list { max-height: 260px; overflow-y: auto; }

        .history-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px 20px;
            border-bottom: 1px solid #f1f5f9;
            transition: background 0.15s;
        }

        .history-item:last-child { border-bottom: none; }
        .history-item:hover { background: #f8fafc; }

        .history-dot {
            width: 10px; height: 10px;
            border-radius: 50%;
            flex-shrink: 0;
        }

        .history-dot.signin { background: var(--gold); box-shadow: 0 0 6px rgba(212,160,23,0.4); }
        .history-dot.signout { background: var(--green); box-shadow: 0 0 6px rgba(16,185,129,0.4); }

        .history-info { flex: 1; min-width: 0; }

        .history-name {
            font-weight: 600;
            font-size: 13px;
            color: var(--text);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .history-meta {
            font-size: 10px;
            color: var(--text-light);
            margin-top: 1px;
        }

        .history-code {
            font-family: 'Bebas Neue', sans-serif;
            font-size: 16px;
            letter-spacing: 1px;
            color: var(--navy);
        }

        .history-empty {
            padding: 30px;
            text-align: center;
            font-size: 13px;
            color: var(--text-light);
        }

        /* ===== STATS PANEL ===== */
        .stats-summary {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
            margin-bottom: 16px;
        }

        .stat-box {
            background: var(--card);
            border-radius: 14px;
            padding: 16px;
            box-shadow: 0 4px 16px rgba(0,0,0,0.05);
            text-align: center;
            position: relative;
            overflow: hidden;
        }

        .stat-box::before {
            content: '';
            position: absolute;
            top: 0; left: 0; right: 0;
            height: 4px;
        }

        .stat-box.navy::before { background: linear-gradient(90deg, var(--navy), var(--navy-light)); }
        .stat-box.gold-s::before { background: linear-gradient(90deg, var(--gold), var(--gold-light)); }
        .stat-box.green-s::before { background: linear-gradient(90deg, var(--green), #34d399); }
        .stat-box.red-s::before { background: linear-gradient(90deg, var(--red), #f87171); }
        .stat-box.teal-s::before { background: linear-gradient(90deg, var(--teal), #2dd4bf); }
        .stat-box.purple-s::before { background: linear-gradient(90deg, var(--purple), #a78bfa); }

        .stat-box.full { grid-column: span 2; }

        .stat-label {
            font-size: 9px;
            font-weight: 700;
            letter-spacing: 1.5px;
            color: var(--text-light);
            text-transform: uppercase;
            margin-bottom: 6px;
        }

        .stat-value {
            font-family: 'Bebas Neue', sans-serif;
            font-size: 32px;
            letter-spacing: 2px;
            line-height: 1;
        }

        .stat-box.navy .stat-value { color: var(--navy); }
        .stat-box.gold-s .stat-value { color: var(--gold-dark); }
        .stat-box.green-s .stat-value { color: var(--green-dark); }
        .stat-box.red-s .stat-value { color: var(--red-dark); }
        .stat-box.teal-s .stat-value { color: var(--teal-dark); }
        .stat-box.purple-s .stat-value { color: var(--purple); }

        .stat-sub {
            font-size: 10px;
            color: var(--text-light);
            margin-top: 2px;
            font-weight: 600;
        }

        /* ===== USER EARNINGS TABLE ===== */
        .earnings-card {
            background: var(--card);
            border-radius: 16px;
            box-shadow: 0 4px 24px rgba(0,0,0,0.06);
            overflow: hidden;
            margin-bottom: 16px;
        }

        .earnings-header {
            padding: 14px 20px;
            background: linear-gradient(135deg, var(--navy-deep), var(--navy-mid));
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .earnings-header-title {
            font-family: 'Bebas Neue', sans-serif;
            font-size: 16px;
            letter-spacing: 2px;
            color: var(--gold);
        }

        .earnings-header-badge {
            font-size: 10px;
            background: rgba(255,193,7,0.2);
            color: var(--gold-light);
            padding: 4px 12px;
            border-radius: 10px;
            font-weight: 700;
            letter-spacing: 1px;
        }

        .earnings-search {
            padding: 12px 20px;
            border-bottom: 1px solid var(--border);
        }

        .earnings-search input {
            width: 100%;
            padding: 10px 14px;
            border: 1px solid var(--border);
            border-radius: 10px;
            font-family: 'Outfit', sans-serif;
            font-size: 13px;
            color: var(--text);
            outline: none;
            background: #f8fafc;
        }

        .earnings-search input:focus { border-color: var(--gold); background: #fff; }

        .earnings-list { max-height: 500px; overflow-y: auto; }

        .earning-item {
            padding: 14px 20px;
            border-bottom: 1px solid #f1f5f9;
            display: flex;
            align-items: center;
            gap: 14px;
            transition: background 0.15s;
            cursor: pointer;
        }

        .earning-item:hover { background: #f8fafc; }
        .earning-item:last-child { border-bottom: none; }

        .earning-avatar {
            width: 40px; height: 40px;
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-family: 'Bebas Neue', sans-serif;
            font-size: 18px;
            letter-spacing: 1px;
            color: #fff;
            flex-shrink: 0;
        }

        .earning-info { flex: 1; min-width: 0; }

        .earning-name {
            font-weight: 600;
            font-size: 14px;
            color: var(--text);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .earning-meta {
            font-size: 11px;
            color: var(--text-light);
            margin-top: 2px;
            display: flex;
            gap: 10px;
        }

        .earning-meta span { display: flex; align-items: center; gap: 3px; }
        .earning-meta .dot-full { width: 6px; height: 6px; border-radius: 50%; background: var(--green); }
        .earning-meta .dot-half { width: 6px; height: 6px; border-radius: 50%; background: var(--orange); }

        .earning-amount {
            text-align: right;
            flex-shrink: 0;
        }

        .earning-total {
            font-family: 'Bebas Neue', sans-serif;
            font-size: 22px;
            letter-spacing: 1px;
            color: var(--navy);
        }

        .earning-currency {
            font-size: 9px;
            font-weight: 700;
            color: var(--text-light);
            letter-spacing: 1px;
        }

        /* User detail modal */
        .user-detail-overlay {
            display: none;
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0,0,0,0.5);
            z-index: 300;
            justify-content: center;
            align-items: flex-end;
            padding: 16px;
        }

        .user-detail-overlay.show { display: flex; }

        .user-detail-panel {
            background: var(--card);
            border-radius: 20px 20px 16px 16px;
            width: 100%;
            max-width: 540px;
            max-height: 80vh;
            overflow-y: auto;
            animation: slideUp 0.3s ease;
        }

        @keyframes slideUp {
            from { transform: translateY(100%); }
            to { transform: translateY(0); }
        }

        .detail-top {
            background: linear-gradient(135deg, var(--navy), var(--navy-mid));
            padding: 24px 20px;
            text-align: center;
            position: relative;
            border-radius: 20px 20px 0 0;
        }

        .detail-close {
            position: absolute;
            top: 12px; right: 14px;
            background: rgba(255,255,255,0.15);
            border: none;
            width: 32px; height: 32px;
            border-radius: 8px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .detail-close svg { width: 16px; height: 16px; stroke: #fff; fill: none; stroke-width: 2.5; }

        .detail-name {
            font-family: 'Bebas Neue', sans-serif;
            font-size: 28px;
            color: #fff;
            letter-spacing: 2px;
        }

        .detail-code {
            font-family: 'Bebas Neue', sans-serif;
            font-size: 18px;
            color: var(--gold);
            letter-spacing: 3px;
            margin-top: 4px;
        }

        .detail-total-box {
            margin-top: 14px;
            background: rgba(255,193,7,0.15);
            display: inline-block;
            padding: 8px 24px;
            border-radius: 12px;
        }

        .detail-total-label {
            font-size: 9px;
            font-weight: 700;
            letter-spacing: 1.5px;
            color: rgba(255,255,255,0.5);
            text-transform: uppercase;
        }

        .detail-total-amount {
            font-family: 'Bebas Neue', sans-serif;
            font-size: 36px;
            color: var(--gold);
            letter-spacing: 2px;
        }

        .detail-body { padding: 20px; }

        .detail-stats {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 8px;
            margin-bottom: 16px;
        }

        .detail-stat {
            text-align: center;
            background: #f8fafc;
            border: 1px solid var(--border);
            border-radius: 10px;
            padding: 10px 6px;
        }

        .detail-stat-val {
            font-family: 'Bebas Neue', sans-serif;
            font-size: 22px;
            letter-spacing: 1px;
        }

        .detail-stat-label {
            font-size: 9px;
            font-weight: 700;
            letter-spacing: 1px;
            color: var(--text-light);
            text-transform: uppercase;
            margin-top: 2px;
        }

        .detail-day-list { max-height: 300px; overflow-y: auto; }

        .detail-day {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 10px 0;
            border-bottom: 1px solid #f1f5f9;
        }

        .detail-day:last-child { border-bottom: none; }

        .detail-day-date {
            font-size: 12px;
            font-weight: 600;
            color: var(--text);
            min-width: 90px;
        }

        .detail-day-badge {
            font-size: 10px;
            font-weight: 700;
            letter-spacing: 1px;
            padding: 3px 10px;
            border-radius: 8px;
        }

        .detail-day-badge.full { background: var(--green-bg); color: var(--green-dark); }
        .detail-day-badge.half { background: var(--orange-bg); color: #b45309; }

        .detail-day-amount {
            margin-left: auto;
            font-family: 'Bebas Neue', sans-serif;
            font-size: 18px;
            letter-spacing: 1px;
            color: var(--navy);
        }

        .detail-day-times {
            font-size: 10px;
            color: var(--text-light);
        }


        /* ===== NOTIFICATION ===== */
        .notif {
            position: fixed;
            top: 16px;
            left: 50%;
            transform: translateX(-50%) translateY(-100px);
            padding: 12px 24px;
            border-radius: 12px;
            font-family: 'Bebas Neue', sans-serif;
            font-size: 14px;
            letter-spacing: 1px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.2);
            z-index: 9999;
            transition: transform 0.3s;
            white-space: nowrap;
        }

        .notif.show { transform: translateX(-50%) translateY(0); }
        .notif.success { background: var(--green); color: #fff; }
        .notif.error { background: var(--red); color: #fff; }
        .notif.info { background: var(--navy); color: var(--gold); }

        /* QR Reader overrides */
        #reader-signin img, #reader-signout img { display: none !important; }
        #reader-signin, #reader-signout { border: none !important; }

        @media (max-width: 400px) {
            .info-grid { grid-template-columns: 1fr; }
            .info-cell.full { grid-column: span 1; }
            .detail-stats { grid-template-columns: 1fr 1fr; }
        }
    </style>
</head>
<body>

    <!-- HEADER -->
    <div class="top-bar">
        <div class="top-bar-inner">
            <div class="brand">
                <div class="brand-badge">
                    <svg viewBox="0 0 24 24">
                        <rect x="2" y="5" width="20" height="14" rx="2"/>
                        <line x1="2" y1="10" x2="22" y2="10"/>
                        <line x1="6" y1="14" x2="10" y2="14"/>
                    </svg>
                </div>
                <div class="brand-text">
                    <h1>PAYMENT TRACKER</h1>
                    <p>Attendance &amp; Earnings System</p>
                </div>
            </div>
            <div class="status-dot"></div>
        </div>
    </div>



    <!-- TABS -->
    <div class="tabs-container">
        <div class="tab-bar">
            <button class="tab-btn signin active" onclick="switchTab('signin')">
                <svg viewBox="0 0 24 24" fill="none" stroke-width="2">
                    <path d="M15 3h4a2 2 0 012 2v14a2 2 0 01-2 2h-4"/>
                    <polyline points="10 17 15 12 10 7"/>
                    <line x1="15" y1="12" x2="3" y2="12"/>
                </svg>
                SIGN IN
            </button>
            <button class="tab-btn signout" onclick="switchTab('signout')">
                <svg viewBox="0 0 24 24" fill="none" stroke-width="2">
                    <path d="M9 21H5a2 2 0 01-2-2V5a2 2 0 012-2h4"/>
                    <polyline points="16 17 21 12 16 7"/>
                    <line x1="21" y1="12" x2="9" y2="12"/>
                </svg>
                SIGN OUT
            </button>
            <button class="tab-btn stats" onclick="switchTab('stats')">
                <svg viewBox="0 0 24 24" fill="none" stroke-width="2">
                    <line x1="18" y1="20" x2="18" y2="10"/>
                    <line x1="12" y1="20" x2="12" y2="4"/>
                    <line x1="6" y1="20" x2="6" y2="14"/>
                </svg>
                STATS
            </button>
        </div>
    </div>

    <!-- MAIN CONTENT -->
    <div class="main">

        <!-- SIGN IN TAB -->
        <div class="tab-panel active" id="panel-signin">
            <div class="scanner-card">
                <div class="scanner-header gold">
                    <svg viewBox="0 0 24 24" fill="none" stroke-width="2">
                        <path d="M23 19a2 2 0 01-2 2H3a2 2 0 01-2-2V8a2 2 0 012-2h4l2-3h6l2 3h4a2 2 0 012 2z"/>
                        <circle cx="12" cy="13" r="4"/>
                    </svg>
                    <span class="scanner-title">SCAN ID TO SIGN IN</span>
                </div>
                <div class="scanner-body">
                    <div id="scan-area-signin">
                        <div class="scan-overlay" id="overlay-signin">
                            <svg viewBox="0 0 24 24" fill="none" stroke="var(--gold)" stroke-width="1.5">
                                <rect x="3" y="3" width="7" height="7" rx="1"/>
                                <rect x="14" y="3" width="7" height="7" rx="1"/>
                                <rect x="3" y="14" width="7" height="7" rx="1"/>
                                <rect x="14" y="14" width="4" height="4"/>
                            </svg>
                            <p>Point camera at user's ID QR code</p>
                            <button class="scan-btn gold-btn" onclick="startScan('signin')">
                                <svg viewBox="0 0 24 24" fill="none" stroke-width="2">
                                    <path d="M23 19a2 2 0 01-2 2H3a2 2 0 01-2-2V8a2 2 0 012-2h4l2-3h6l2 3h4a2 2 0 012 2z"/>
                                    <circle cx="12" cy="13" r="4"/>
                                </svg>
                                START SCANNER
                            </button>
                        </div>
                        <div id="reader-signin" style="display:none;"></div>
                        <div style="text-align:center; display:none;" id="stop-signin">
                            <button class="scan-btn stop-btn" onclick="stopScan('signin')" style="margin-top:12px;">
                                STOP SCANNER
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <div class="device-card" id="device-signin"></div>
            <div class="msg-card" id="msg-signin"></div>

            <div class="history-card" id="history-signin">
                <div class="history-header">
                    <span class="history-title">TODAY'S SIGN-INS</span>
                    <span class="history-count" id="signin-count">0</span>
                </div>
                <div class="history-list" id="signin-list">
                    <div class="history-empty">No sign-ins today</div>
                </div>
            </div>
        </div>

        <!-- SIGN OUT TAB -->
        <div class="tab-panel" id="panel-signout">
            <div class="scanner-card">
                <div class="scanner-header green-hd">
                    <svg viewBox="0 0 24 24" fill="none" stroke-width="2">
                        <path d="M9 21H5a2 2 0 01-2-2V5a2 2 0 012-2h4"/>
                        <polyline points="16 17 21 12 16 7"/>
                        <line x1="21" y1="12" x2="9" y2="12"/>
                    </svg>
                    <span class="scanner-title">SCAN ID TO SIGN OUT</span>
                </div>
                <div class="scanner-body">
                    <div id="scan-area-signout">
                        <div class="scan-overlay" id="overlay-signout">
                            <svg viewBox="0 0 24 24" fill="none" stroke="var(--green)" stroke-width="1.5">
                                <rect x="3" y="3" width="7" height="7" rx="1"/>
                                <rect x="14" y="3" width="7" height="7" rx="1"/>
                                <rect x="3" y="14" width="7" height="7" rx="1"/>
                                <rect x="14" y="14" width="4" height="4"/>
                            </svg>
                            <p>Point camera at user's ID QR code</p>
                            <button class="scan-btn green-btn" onclick="startScan('signout')">
                                <svg viewBox="0 0 24 24" fill="none" stroke-width="2">
                                    <path d="M23 19a2 2 0 01-2 2H3a2 2 0 01-2-2V8a2 2 0 012-2h4l2-3h6l2 3h4a2 2 0 012 2z"/>
                                    <circle cx="12" cy="13" r="4"/>
                                </svg>
                                START SCANNER
                            </button>
                        </div>
                        <div id="reader-signout" style="display:none;"></div>
                        <div style="text-align:center; display:none;" id="stop-signout">
                            <button class="scan-btn stop-btn" onclick="stopScan('signout')" style="margin-top:12px;">
                                STOP SCANNER
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <div class="device-card" id="device-signout"></div>
            <div class="msg-card" id="msg-signout"></div>

            <div class="history-card" id="history-signout">
                <div class="history-header">
                    <span class="history-title">TODAY'S SIGN-OUTS</span>
                    <span class="history-count" id="signout-count">0</span>
                </div>
                <div class="history-list" id="signout-list">
                    <div class="history-empty">No sign-outs today</div>
                </div>
            </div>
        </div>

        <!-- STATS TAB -->
        <div class="tab-panel" id="panel-stats">
            <div class="stats-summary" id="statsSummary">
                <div class="stat-box navy">
                    <div class="stat-label">Total Users</div>
                    <div class="stat-value" id="totalUsers">0</div>
                </div>
                <div class="stat-box gold-s">
                    <div class="stat-label">Total Days Tracked</div>
                    <div class="stat-value" id="totalDays">0</div>
                </div>
                <div class="stat-box green-s">
                    <div class="stat-label">Full Days</div>
                    <div class="stat-value" id="totalFull">0</div>
                    <div class="stat-sub">Sign In + Sign Out</div>
                </div>
                <div class="stat-box red-s">
                    <div class="stat-label">Half Days</div>
                    <div class="stat-value" id="totalHalf">0</div>
                    <div class="stat-sub">Sign In Only</div>
                </div>
                <div class="stat-box teal-s full">
                    <div class="stat-label">Total Payable Amount</div>
                    <div class="stat-value" id="totalPay">0</div>
                </div>
            </div>

            <div class="earnings-card">
                <div class="earnings-header">
                    <div class="earnings-header-title">USER EARNINGS</div>
                    <div class="earnings-header-badge" id="earningsUserCount">0 USERS</div>
                </div>
                <div class="earnings-search">
                    <input type="text" placeholder="Search by name or ID..." id="searchEarnings" oninput="renderEarnings()">
                </div>
                <div class="earnings-list" id="earningsList">
                    <div class="history-empty">No attendance data yet</div>
                </div>
            </div>
        </div>
    </div>

    <!-- USER DETAIL OVERLAY -->
    <div class="user-detail-overlay" id="userDetailOverlay" onclick="closeDetail(event)">
        <div class="user-detail-panel" id="userDetailPanel"></div>
    </div>

    <!-- NOTIFICATION -->
    <div class="notif" id="notif"></div>

<script>
// ============================================
// CONFIGURATION — EDIT THESE VALUES DIRECTLY
// ============================================
const SCRIPT_URL = '';  // Google Apps Script URL — paste your URL here
const FULL_PAY = 200;   // Payment for full day (sign in + sign out)
const HALF_PAY = 100;   // Payment for half day (sign in only)
const CURRENCY = 'Le';  // Currency label

// ============================================
// DATA
// ============================================
let signIns = JSON.parse(localStorage.getItem('pt_signins') || '[]');
let signOuts = JSON.parse(localStorage.getItem('pt_signouts') || '[]');
let scanners = {};

function getToday() {
    return new Date().toISOString().split('T')[0];
}

function parseQR(text) {
    // Try JSON first
    try {
        const obj = JSON.parse(text);
        return {
            code: obj.code || obj.id || obj.ID || obj.Code || text,
            name: obj.name || obj.Name || obj.fullName || '',
            phone: obj.phone || obj.Phone || obj.tel || '',
            district: obj.district || obj.District || '',
            chiefdom: obj.chiefdom || obj.Chiefdom || '',
            section: obj.section || obj.Section || '',
            facility: obj.facility || obj.Facility || '',
            community: obj.community || obj.Community || '',
            role: obj.role || obj.Role || obj.position || ''
        };
    } catch (e) {
        // Try key=value pairs
        if (text.includes('=') || text.includes(':')) {
            const pairs = {};
            text.split(/[,;\n&]/).forEach(p => {
                const [k, ...v] = p.split(/[=:]/);
                if (k && v.length) pairs[k.trim().toLowerCase()] = v.join(':').trim();
            });
            return {
                code: pairs.code || pairs.id || text,
                name: pairs.name || pairs.fullname || '',
                phone: pairs.phone || pairs.tel || '',
                district: pairs.district || '',
                chiefdom: pairs.chiefdom || '',
                section: pairs.section || '',
                facility: pairs.facility || '',
                community: pairs.community || '',
                role: pairs.role || pairs.position || ''
            };
        }
        // Plain text = code
        return { code: text.trim(), name: '', phone: '', district: '', chiefdom: '', section: '', facility: '', community: '', role: '' };
    }
}

// ============================================
// TABS
// ============================================
function switchTab(tab) {
    document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
    document.querySelectorAll('.tab-panel').forEach(p => p.classList.remove('active'));
    document.querySelector('.tab-btn.' + tab).classList.add('active');
    document.getElementById('panel-' + tab).classList.add('active');

    // Stop any running scanners
    Object.keys(scanners).forEach(k => {
        if (scanners[k]) {
            try { scanners[k].stop(); } catch(e) {}
            scanners[k] = null;
        }
    });

    if (tab === 'stats') updateStats();
}

// ============================================
// SCANNER
// ============================================
function startScan(mode) {
    const overlay = document.getElementById('overlay-' + mode);
    const readerEl = document.getElementById('reader-' + mode);
    const stopEl = document.getElementById('stop-' + mode);

    overlay.style.display = 'none';
    readerEl.style.display = 'block';
    stopEl.style.display = 'block';

    if (scanners[mode]) {
        try { scanners[mode].stop(); } catch(e) {}
    }

    const scanner = new Html5Qrcode('reader-' + mode);
    scanners[mode] = scanner;

    scanner.start(
        { facingMode: 'environment' },
        { fps: 10, qrbox: { width: 220, height: 220 }, aspectRatio: 1 },
        (decoded) => {
            scanner.stop().then(() => {
                scanners[mode] = null;
                readerEl.style.display = 'none';
                stopEl.style.display = 'none';
                overlay.style.display = 'block';
                handleScan(mode, decoded);
            });
        },
        () => {}
    ).catch(err => {
        console.error('Camera error:', err);
        overlay.style.display = 'block';
        readerEl.style.display = 'none';
        stopEl.style.display = 'none';
        showNotif('Camera access denied', 'error');
    });
}

function stopScan(mode) {
    if (scanners[mode]) {
        scanners[mode].stop().then(() => {
            scanners[mode] = null;
            document.getElementById('reader-' + mode).style.display = 'none';
            document.getElementById('stop-' + mode).style.display = 'none';
            document.getElementById('overlay-' + mode).style.display = 'block';
        });
    }
}

// ============================================
// HANDLE SCAN
// ============================================
function handleScan(mode, text) {
    const data = parseQR(text);
    const today = getToday();

    if (mode === 'signin') {
        handleSignIn(data, today);
    } else {
        handleSignOut(data, today);
    }
}

function handleSignIn(data, today) {
    // Check if already signed in today
    const alreadyIn = signIns.find(s => s.code === data.code && s.date === today);
    if (alreadyIn) {
        showUserCard('signin', data, 'orange-top', 'badge-warning', 'ALREADY SIGNED IN',
            'This user already signed in today at ' + new Date(alreadyIn.timestamp).toLocaleTimeString(), false);
        return;
    }

    // Show card for confirmation
    showUserCard('signin', data, 'gold-top', 'badge-register', 'READY TO SIGN IN', null, true);
}

function handleSignOut(data, today) {
    // Check if signed in today
    const signedIn = signIns.find(s => s.code === data.code && s.date === today);
    if (!signedIn) {
        showUserCard('signout', data, 'red-top', 'badge-error', 'NOT SIGNED IN',
            'This user has not signed in today. They must sign in first.', false);
        return;
    }

    // Check if already signed out today
    const alreadyOut = signOuts.find(s => s.code === data.code && s.date === today);
    if (alreadyOut) {
        showUserCard('signout', data, 'orange-top', 'badge-warning', 'ALREADY SIGNED OUT',
            'This user already signed out today at ' + new Date(alreadyOut.timestamp).toLocaleTimeString(), false);
        return;
    }

    showUserCard('signout', data, 'green-top', 'badge-returned', 'READY TO SIGN OUT', null, true);
}

// ============================================
// CONFIRM ACTIONS
// ============================================
function confirmSignIn() {
    const card = document.getElementById('device-signin');
    const data = JSON.parse(card.dataset.userData);
    const btn = card.querySelector('.action-btn');

    btn.disabled = true;
    btn.innerHTML = '<div class="spinner-sm"></div> PROCESSING...';

    const record = {
        code: data.code,
        name: data.name || '',
        phone: data.phone || '',
        district: data.district || '',
        chiefdom: data.chiefdom || '',
        section: data.section || '',
        facility: data.facility || '',
        community: data.community || '',
        role: data.role || '',
        action: 'SIGN_IN',
        date: getToday(),
        timestamp: new Date().toISOString()
    };

    signIns.push(record);
    localStorage.setItem('pt_signins', JSON.stringify(signIns));

    submitToSheets(record, function() {
        card.classList.remove('show');
        showMessage('signin', 'success', 'SIGNED IN',
            data.name + ' — ID: ' + data.code,
            'Signed in at ' + new Date().toLocaleTimeString());
        updateHistory();
        showNotif('Sign-in recorded!', 'success');
    });
}

function confirmSignOut() {
    const card = document.getElementById('device-signout');
    const data = JSON.parse(card.dataset.userData);
    const btn = card.querySelector('.action-btn');

    btn.disabled = true;
    btn.innerHTML = '<div class="spinner-sm"></div> PROCESSING...';

    const record = {
        code: data.code,
        name: data.name || '',
        phone: data.phone || '',
        district: data.district || '',
        chiefdom: data.chiefdom || '',
        section: data.section || '',
        facility: data.facility || '',
        community: data.community || '',
        role: data.role || '',
        action: 'SIGN_OUT',
        date: getToday(),
        timestamp: new Date().toISOString()
    };

    signOuts.push(record);
    localStorage.setItem('pt_signouts', JSON.stringify(signOuts));

    submitToSheets(record, function() {
        card.classList.remove('show');
        showMessage('signout', 'success', 'SIGNED OUT',
            data.name + ' — ID: ' + data.code,
            'Full day payment earned: ' + CURRENCY + ' ' + FULL_PAY);
        updateHistory();
        showNotif('Sign-out recorded!', 'success');
    });
}

// ============================================
// DISPLAY HELPERS
// ============================================
function showUserCard(mode, data, topClass, badgeClass, badgeText, note, showAction) {
    const card = document.getElementById('device-' + mode);
    document.getElementById('msg-' + mode).classList.remove('show');

    const statusIcon = badgeClass === 'badge-register' ?
        '<svg viewBox="0 0 24 24" stroke-width="2"><path d="M15 3h4a2 2 0 012 2v14a2 2 0 01-2 2h-4"/><polyline points="10 17 15 12 10 7"/><line x1="15" y1="12" x2="3" y2="12"/></svg>' :
        badgeClass === 'badge-returned' ?
        '<svg viewBox="0 0 24 24" stroke-width="2"><polyline points="20 6 9 17 4 12"/></svg>' :
        badgeClass === 'badge-error' ?
        '<svg viewBox="0 0 24 24" stroke-width="2"><circle cx="12" cy="12" r="10"/><line x1="15" y1="9" x2="9" y2="15"/><line x1="9" y1="9" x2="15" y2="15"/></svg>' :
        '<svg viewBox="0 0 24 24" stroke-width="2"><path d="M10.29 3.86L1.82 18a2 2 0 001.71 3h16.94a2 2 0 001.71-3L13.71 3.86a2 2 0 00-3.42 0z"/><line x1="12" y1="9" x2="12" y2="13"/><line x1="12" y1="17" x2="12.01" y2="17"/></svg>';

    // Calculate current earnings for this user
    const earnings = getUserEarnings(data.code);
    const earningsHTML = earnings ? `
        <div class="info-cell full" style="background: var(--gold-pale); border-color: var(--gold);">
            <div class="info-key" style="color: var(--gold-dark);">Cumulative Earnings</div>
            <div class="info-val" style="color: var(--navy); font-size: 18px; font-family: 'Bebas Neue', sans-serif; letter-spacing: 2px;">${CURRENCY} ${earnings.total.toLocaleString()} <span style="font-size: 11px; color: var(--text-light); font-family: 'Outfit';">(${earnings.fullDays} full + ${earnings.halfDays} half days)</span></div>
        </div>
    ` : '';

    let actionHTML = '';
    if (showAction && mode === 'signin') {
        actionHTML = '<button class="action-btn register-action" onclick="confirmSignIn()"><svg viewBox="0 0 24 24" stroke-width="2"><path d="M15 3h4a2 2 0 012 2v14a2 2 0 01-2 2h-4"/><polyline points="10 17 15 12 10 7"/><line x1="15" y1="12" x2="3" y2="12"/></svg>CONFIRM SIGN IN</button>';
    } else if (showAction && mode === 'signout') {
        actionHTML = '<button class="action-btn return-action" onclick="confirmSignOut()"><svg viewBox="0 0 24 24" stroke-width="2"><path d="M9 21H5a2 2 0 01-2-2V5a2 2 0 012-2h4"/><polyline points="16 17 21 12 16 7"/><line x1="21" y1="12" x2="9" y2="12"/></svg>CONFIRM SIGN OUT</button>';
    }

    let noteHTML = note ? '<div style="background:' + (badgeClass === 'badge-error' ? 'var(--red-bg)' : 'var(--orange-bg)') + ';padding:10px 14px;border-radius:10px;font-size:13px;color:var(--text-mid);font-weight:500;margin-bottom:16px;">' + note + '</div>' : '';

    card.innerHTML = `
        <div class="device-card-top ${topClass}">
            <div class="device-status-badge ${badgeClass}">${statusIcon} ${badgeText}</div>
            <div class="device-person">${data.name || 'Unknown'}</div>
            <div class="device-phone">${data.role || data.phone || '—'}</div>
            <div class="device-code-display">${data.code}</div>
        </div>
        <div class="device-body">
            ${noteHTML}
            <div class="info-grid">
                <div class="info-cell"><div class="info-key">District</div><div class="info-val">${data.district || '—'}</div></div>
                <div class="info-cell"><div class="info-key">Chiefdom</div><div class="info-val">${data.chiefdom || '—'}</div></div>
                <div class="info-cell"><div class="info-key">Phone</div><div class="info-val">${data.phone || '—'}</div></div>
                <div class="info-cell"><div class="info-key">Facility</div><div class="info-val">${data.facility || '—'}</div></div>
                ${earningsHTML}
            </div>
            ${actionHTML}
        </div>
    `;

    card.dataset.userData = JSON.stringify(data);
    card.classList.add('show');
}

function showMessage(mode, type, title, text, detail) {
    const card = document.getElementById('msg-' + mode);
    document.getElementById('device-' + mode).classList.remove('show');

    const iconMap = {
        success: '<svg viewBox="0 0 24 24" fill="none" stroke-width="2"><circle cx="12" cy="12" r="10"/><polyline points="16 8 10 16 7 13"/></svg>',
        error: '<svg viewBox="0 0 24 24" fill="none" stroke-width="2"><circle cx="12" cy="12" r="10"/><line x1="15" y1="9" x2="9" y2="15"/><line x1="9" y1="9" x2="15" y2="15"/></svg>',
        warning: '<svg viewBox="0 0 24 24" fill="none" stroke-width="2"><path d="M10.29 3.86L1.82 18a2 2 0 001.71 3h16.94a2 2 0 001.71-3L13.71 3.86a2 2 0 00-3.42 0z"/><line x1="12" y1="9" x2="12" y2="13"/><line x1="12" y1="17" x2="12.01" y2="17"/></svg>'
    };

    card.className = 'msg-card show ' + type + '-msg';
    card.innerHTML = `
        ${iconMap[type]}
        <div class="msg-title">${title}</div>
        <div class="msg-text">${text}</div>
        ${detail ? '<div class="msg-detail">' + detail + '</div>' : ''}
        <button class="scan-again-btn" onclick="scanAgain('${mode}')">SCAN ANOTHER</button>
    `;
}

function scanAgain(mode) {
    document.getElementById('msg-' + mode).classList.remove('show');
    document.getElementById('device-' + mode).classList.remove('show');
    startScan(mode);
}

// ============================================
// EARNINGS CALCULATION
// ============================================
function getUserEarnings(code) {
    const userSignIns = signIns.filter(s => s.code === code);
    if (userSignIns.length === 0) return null;

    const dates = [...new Set(userSignIns.map(s => s.date))];
    let fullDays = 0;
    let halfDays = 0;

    dates.forEach(date => {
        const hasOut = signOuts.some(s => s.code === code && s.date === date);
        if (hasOut) fullDays++;
        else halfDays++;
    });

    return {
        fullDays,
        halfDays,
        totalDays: fullDays + halfDays,
        total: (fullDays * FULL_PAY) + (halfDays * HALF_PAY)
    };
}

function getAllUserEarnings() {
    const userMap = {};

    signIns.forEach(s => {
        if (!userMap[s.code]) {
            userMap[s.code] = {
                code: s.code,
                name: s.name || 'Unknown',
                phone: s.phone || '',
                district: s.district || '',
                role: s.role || '',
                dates: {}
            };
        }
        // Update name if we have a better one
        if (s.name && s.name !== 'Unknown') userMap[s.code].name = s.name;
        userMap[s.code].dates[s.date] = { signIn: s.timestamp, signOut: null };
    });

    signOuts.forEach(s => {
        if (userMap[s.code] && userMap[s.code].dates[s.date]) {
            userMap[s.code].dates[s.date].signOut = s.timestamp;
        }
    });

    // Calculate earnings
    return Object.values(userMap).map(user => {
        let fullDays = 0;
        let halfDays = 0;
        const dayList = [];

        Object.keys(user.dates).sort().reverse().forEach(date => {
            const day = user.dates[date];
            const isFull = !!day.signOut;
            if (isFull) fullDays++; else halfDays++;
            dayList.push({
                date,
                signIn: day.signIn,
                signOut: day.signOut,
                type: isFull ? 'full' : 'half',
                amount: isFull ? FULL_PAY : HALF_PAY
            });
        });

        return {
            ...user,
            fullDays,
            halfDays,
            totalDays: fullDays + halfDays,
            total: (fullDays * FULL_PAY) + (halfDays * HALF_PAY),
            dayList
        };
    }).sort((a, b) => b.total - a.total);
}

// ============================================
// GOOGLE SHEETS
// ============================================
function submitToSheets(record, callback) {
    if (!SCRIPT_URL) {
        callback();
        return;
    }

    fetch(SCRIPT_URL, {
        method: 'POST',
        mode: 'no-cors',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(record)
    }).then(() => {
        callback();
    }).catch(err => {
        console.error('Sheets error:', err);
        callback();
    });
}

// ============================================
// HISTORY UPDATE
// ============================================
function updateHistory() {
    const today = getToday();

    // Sign-ins today
    const todayIns = signIns.filter(s => s.date === today).reverse();
    document.getElementById('signin-count').textContent = todayIns.length;
    const siList = document.getElementById('signin-list');

    if (todayIns.length === 0) {
        siList.innerHTML = '<div class="history-empty">No sign-ins today</div>';
    } else {
        siList.innerHTML = todayIns.map(d => `
            <div class="history-item">
                <div class="history-dot signin"></div>
                <div class="history-info">
                    <div class="history-name">${d.name || 'Unknown'}</div>
                    <div class="history-meta">${d.district || ''} · ${new Date(d.timestamp).toLocaleTimeString()}</div>
                </div>
                <div class="history-code">${d.code}</div>
            </div>
        `).join('');
    }

    // Sign-outs today
    const todayOuts = signOuts.filter(s => s.date === today).reverse();
    document.getElementById('signout-count').textContent = todayOuts.length;
    const soList = document.getElementById('signout-list');

    if (todayOuts.length === 0) {
        soList.innerHTML = '<div class="history-empty">No sign-outs today</div>';
    } else {
        soList.innerHTML = todayOuts.map(d => `
            <div class="history-item">
                <div class="history-dot signout"></div>
                <div class="history-info">
                    <div class="history-name">${d.name || 'Unknown'}</div>
                    <div class="history-meta">${d.district || ''} · ${new Date(d.timestamp).toLocaleTimeString()}</div>
                </div>
                <div class="history-code">${d.code}</div>
            </div>
        `).join('');
    }
}

// ============================================
// STATS UPDATE
// ============================================
function updateStats() {
    const allEarnings = getAllUserEarnings();

    let totalFull = 0, totalHalf = 0, totalPay = 0;
    const allDates = new Set();

    allEarnings.forEach(u => {
        totalFull += u.fullDays;
        totalHalf += u.halfDays;
        totalPay += u.total;
        u.dayList.forEach(d => allDates.add(d.date));
    });

    document.getElementById('totalUsers').textContent = allEarnings.length;
    document.getElementById('totalDays').textContent = allDates.size;
    document.getElementById('totalFull').textContent = totalFull;
    document.getElementById('totalHalf').textContent = totalHalf;
    document.getElementById('totalPay').textContent = CURRENCY + ' ' + totalPay.toLocaleString();
    document.getElementById('earningsUserCount').textContent = allEarnings.length + ' USERS';

    renderEarnings();
}

function renderEarnings() {
    const allEarnings = getAllUserEarnings();
    const search = (document.getElementById('searchEarnings').value || '').toLowerCase();
    const filtered = allEarnings.filter(u =>
        u.name.toLowerCase().includes(search) || u.code.toLowerCase().includes(search)
    );

    const list = document.getElementById('earningsList');

    if (filtered.length === 0) {
        list.innerHTML = '<div class="history-empty">' + (search ? 'No matching users' : 'No attendance data yet') + '</div>';
        return;
    }

    const colors = ['#0056a8', '#0d9488', '#7c3aed', '#dc3545', '#e6a800', '#1e7e34', '#b45309', '#6366f1'];

    list.innerHTML = filtered.map((u, i) => {
        const initials = u.name ? u.name.split(' ').map(w => w[0]).join('').substring(0, 2).toUpperCase() : u.code.substring(0, 2);
        const bg = colors[i % colors.length];

        return `
            <div class="earning-item" onclick='showUserDetail(${JSON.stringify(JSON.stringify(u))})'>
                <div class="earning-avatar" style="background: ${bg};">${initials}</div>
                <div class="earning-info">
                    <div class="earning-name">${u.name || u.code}</div>
                    <div class="earning-meta">
                        <span><span class="dot-full"></span> ${u.fullDays} full</span>
                        <span><span class="dot-half"></span> ${u.halfDays} half</span>
                        <span>${u.totalDays} days</span>
                    </div>
                </div>
                <div class="earning-amount">
                    <div class="earning-total">${CURRENCY} ${u.total.toLocaleString()}</div>
                    <div class="earning-currency">LEONE</div>
                </div>
            </div>
        `;
    }).join('');
}

// ============================================
// USER DETAIL
// ============================================
function showUserDetail(jsonStr) {
    const u = JSON.parse(jsonStr);
    const panel = document.getElementById('userDetailPanel');

    panel.innerHTML = `
        <div class="detail-top">
            <button class="detail-close" onclick="closeDetail(event, true)">
                <svg viewBox="0 0 24 24"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>
            </button>
            <div class="detail-name">${u.name || 'Unknown'}</div>
            <div class="detail-code">${u.code}</div>
            <div class="detail-total-box">
                <div class="detail-total-label">Total Earnings</div>
                <div class="detail-total-amount">${CURRENCY} ${u.total.toLocaleString()}</div>
            </div>
        </div>
        <div class="detail-body">
            <div class="detail-stats">
                <div class="detail-stat">
                    <div class="detail-stat-val" style="color: var(--navy);">${u.totalDays}</div>
                    <div class="detail-stat-label">Total Days</div>
                </div>
                <div class="detail-stat">
                    <div class="detail-stat-val" style="color: var(--green-dark);">${u.fullDays}</div>
                    <div class="detail-stat-label">Full Days</div>
                </div>
                <div class="detail-stat">
                    <div class="detail-stat-val" style="color: var(--orange);">${u.halfDays}</div>
                    <div class="detail-stat-label">Half Days</div>
                </div>
            </div>

            <div style="font-family:'Bebas Neue',sans-serif; font-size:14px; letter-spacing:2px; color:var(--text-mid); margin-bottom:10px;">
                DAILY BREAKDOWN
            </div>

            <div class="detail-day-list">
                ${u.dayList.map(d => `
                    <div class="detail-day">
                        <div>
                            <div class="detail-day-date">${formatDate(d.date)}</div>
                            <div class="detail-day-times">
                                In: ${new Date(d.signIn).toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'})}
                                ${d.signOut ? ' · Out: ' + new Date(d.signOut).toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'}) : ' · No sign-out'}
                            </div>
                        </div>
                        <div class="detail-day-badge ${d.type}">${d.type === 'full' ? 'FULL DAY' : 'HALF DAY'}</div>
                        <div class="detail-day-amount">${CURRENCY} ${d.amount.toLocaleString()}</div>
                    </div>
                `).join('')}
            </div>
        </div>
    `;

    document.getElementById('userDetailOverlay').classList.add('show');
}

function closeDetail(event, force) {
    if (force || event.target === document.getElementById('userDetailOverlay')) {
        document.getElementById('userDetailOverlay').classList.remove('show');
    }
}

function formatDate(dateStr) {
    const d = new Date(dateStr + 'T00:00:00');
    return d.toLocaleDateString('en-US', { weekday: 'short', month: 'short', day: 'numeric' });
}

// ============================================
// NOTIFICATION
// ============================================
function showNotif(msg, type) {
    const el = document.getElementById('notif');
    el.textContent = msg;
    el.className = 'notif show ' + (type || 'info');
    setTimeout(() => { el.className = 'notif'; }, 2500);
}

// ============================================
// INIT
// ============================================
updateHistory();
</script>
</body>
</html>
